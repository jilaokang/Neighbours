<template>
  <!--pages/wgql/wgql.wxml-->
  <view style="overflow:hidden;height:100vh;background:#ffffff">
    <view id="topNav" class="container">
      <view class="row center_middle">
        <view class="col-3 location">切换社区</view>
        <view class="col-6 notice">您有3条新通知</view>
        <view class="col-1">
          <navigator url="/pages/chat/roominfo/index">
            <view class="iconfont icon-me"></view>
          </navigator>
        </view>
      </view>
    </view>
    <scroll-view id="chatMain" scroll-y scroll-top="{{scrollTop}}" style="{{showFooterNav?'height:44vh':''}}">
      <repeat wx:for="{{msgList}}" wx:key="index">
        <myMsg wx:if="{{item.content.uid==openId}}" :value.sync="item.content"></myMsg>
        <otherMsg wx:else :value.sync="item.content"></otherMsg>
      </repeat>
      <view style="height: 8vh"></view>
    </scroll-view>
    <!-- 聊天输入框 -->
    <view class="lv_tabber">
      <view class="tabber-inputs-box lv_border_top">
        <view class="lv_tabber-inputs">
          <view class="iconfont icon-yuyin"></view>
          <textarea auto-height class="lv_textareas lv_border_bottom" value="{{msgData.data.mine.content}}" @input="getMsg" show-confirm-bar="" maxlength='-1'
          />
        <view class="icon-biaoqing iconfont" style="margin-right:13px"></view>
        <view wx:if="{{!showFooterSendButton}}" @tap="isBack(showFooterNav)"  class="iconfont icon-jia1"></view>
          <view wx:if="{{showFooterSendButton}}" class="btn-red btn" @tap="postMsg">发送</view>
        </view>
      </view>

      <view wx:if="{{showFooterNav}}" id="swiper">
        <swiper style="height:40vh;" duration="400" indicator-dots="true" bindchange="swiperTab">
          <swiper-item>
            <view class="wgql-flex-img wgql-flex-img-mag">
              <view class="wgql-img-box">
                <navigator class="wgql-navigator" url="">
                  <view class="wgql-img">
                    <view class="wgql-img-mag">
                      <view class="iconfont icon-zhaopian"></view>
                      </view>
                  </view>
                </navigator>
                <text>照片</text>
              </view>
              <view class="wgql-img-box">
                <navigator class="wgql-navigator" url="">
                  <view class="wgql-img">
                    <view class="wgql-img-mag">
                      <view class="iconfont icon-zhaopian1"></view>
                      </view>
                  </view>
                </navigator>
                <text>拍摄</text>
              </view>
              <view class="wgql-img-box">
                <navigator class="wgql-navigator" url="">
                  <view class="wgql-img">
                    <view class="wgql-img-mag">
                      <view class="iconfont icon-yuyin1"></view>
                      </view>
                  </view>
                </navigator>
                <text>语音输入</text>
              </view>
              <view class="wgql-img-box">
                <navigator class="wgql-navigator" url="">
                  <view class="wgql-img">
                    <view class="wgql-img-mag">
                      <view class="iconfont icon-wenjian"></view>
                      </view>
                  </view>
                </navigator>
                <text>文件</text>
              </view>
            </view>
            <view class="wgql-flex-img">
              <view class="wgql-img-box">
                <navigator class="wgql-navigator" url="/pages/pushdeal/index">
                  <view class="wgql-img">
                    <view class="wgql-img-mag">
                      <view class="iconfont icon-yuyin1"></view>
                      </view>
                  </view>
                </navigator>
                <text>我要说事</text>
              </view>
              <view class="wgql-img-box">
                <navigator class="wgql-navigator" url="/pages/wish/index">
                  <view class="wgql-img">
                    <view class="wgql-img-mag">
                      <view class="iconfont icon-huodong5050"></view>
                      </view>
                  </view>
                </navigator>
                <text>我要参与</text>
              </view>
              <view class="wgql-img-box">
                <navigator class="wgql-navigator" url="">
                  <view class="wgql-img">
                    <view class="wgql-img-mag">
                      <view class="iconfont icon-qiandao-kaoqindaqia"></view>
                      </view>
                  </view>
                </navigator>
                <text>党员打卡</text>
              </view>
              <view class="wgql-img-box">
                <navigator class="wgql-navigator" url="/pages/underworld/index">
                  <view class="wgql-img">
                    <view class="wgql-img-mag">
                      <view class="iconfont icon-dajimubiao  "></view>
                      </view>
                  </view>
                </navigator>
                <text>扫黑除恶</text>
              </view>
            </view>
          </swiper-item>
          <swiper-item>
            <view class="wgql-flex-img-b  wgql-flex-img-mag">
              <view class="wgql-img-box">
                <navigator class="wgql-navigator" url="">
                  <view class="wgql-img">
                    <view class="wgql-img-mag">
                      <view class="icon-keep iconfont"></view>
                    </view>
                  </view>
                </navigator>
                <text>收藏</text>
              </view>
              <view class="wgql-img-box">
                <navigator class="wgql-navigator" url="">
                  <view class="wgql-img">
                    <view class="wgql-img-mag">
                      <view class="iconfont icon-wenda2"></view>
                      </view>
                  </view>
                </navigator>
                <text>有奖问答</text>
              </view>
              <view class="wgql-img-box">
                <navigator class="wgql-navigator" url="">
                  <view class="wgql-img">
                    <view class="wgql-img-mag">
                      <view class="iconfont icon-mingpian"></view>
                      </view>
                  </view>
                </navigator>
                <text>名片</text>
              </view>
            </view>
          </swiper-item>
        </swiper>
      </view>
    </view>
  </view>
</template>

<script>
import wepy from 'wepy';
import otherMsg from '../../coomponent/otherMsg';
import myMsg from '../../coomponent/myMsg';

export default class chat extends wepy.page {
  components = {
    otherMsg: otherMsg,
    myMsg: myMsg
  };

  data = {
    scrollTop: 0,
    focus: false,
    openId: '',
    showFooterNav: false,
    showFooterSendButton: false,

    userInfo: {},
    msgList: [],
    msgData: {
      type: 'chatMessage',
      data: {
        mine: {
          id: '',
          wangge_id: '3108',
          content: ''
        },
        to: {
          id: '3108',
          type: 'other'
        }
      }
    }
  };

  methods = {
    isBack: value => (this[value] = !this[value]),
    isShow: value => (this[value] = true),
    isHidden: value => (this[value] = false),
    getMsg: e => {
      this.msgData.data.mine.content = e.detail.value;
      this.showFooterSendButton = e.detail.value ? true : false;
      this.$apply();
    },
    postMsg: () => {
      let that = this;
      let postMsgData = JSON.stringify(this.msgData);
      setTimeout(() => {
        wepy
          .sendSocketMessage({
            data: postMsgData
          })
          .then(() => {
            that.showFooterNav = false;
            that.showFooterSendButton = false;
            that.msgData.data.mine.content = '';
            that.$apply();
          });
      }, 50);
    }
  };

  onShow() {
    let that = this;
    wx.login({
      success: res => {
        let url = `https://wll.tenqent.com/index.php/Api/GetWechatApi/getSessionKey/code/${
          res.code
        }.html`;
        wx.request({
          url: url,
          success: res => {
            console.log('openid from:' + res.data.openid);
            console.log(res);
            that.openId = res.data.openid;
            that.msgData.data.mine.id = res.data.openid;
          }
        });
      }
    });

    wx.getUserInfo({
      success: function(res) {
        that.userInfo = res.userInfo;
        console.log(res.userInfo);
      }
    });
  }

  onLoad() {
    let that = this;

    setTimeout(() => {
      console.log('openid : ' + that.openId);

      var loginData = JSON.stringify({
        type: 'init',
        data: {
          mine: {
            id: that.openId,
            wangge_id: '3108',
            avatar: that.userInfo.avatarUrl,
            username: that.userInfo.nickName
          }
        }
      });

      console.log(loginData);

      wx.request({
        url: 'http://qungongbu.tenqent.com/Api/WechatIm/getChatLogwll.html',
        success: res => {
          that.msgList = that.msgList.concat(...res.data.data);
          that.scrollTop = res.data.data.length * 50;
          this.$apply();
        }
      });

      wx.connectSocket({
        url: 'wss://wll.tenqent.com:4431'
      });

      wx.onSocketOpen(() => {
        wx.sendSocketMessage({
          data: loginData
        });

        wx.onSocketMessage(res => {
          let data = JSON.parse(res.data);
          console.log(data);
          data.type !== 'ping' ? this.msgList.push(data) : null;
          this.scrollTop = this.scrollTop + 1000;
          this.$apply();
        });
      });

      wx.onSocketError(res => console.log(`error${res}`));
    }, 1000);
  }
}
</script>

<style lang="scss" scoped>
@import '../../static/base';

#swiper {
  background: #ffffff;
}
#topNav {
  padding-top: 10px;
  padding-bottom: 10px;
  .location {
    font-size: 16px;
  }
  .notice {
    font-size: 14px;
    color: darkred;
  }
  .iconfont {
    text-align: center;
    font-size: 18px;
    color: #999999;
  }
}

#chatMain {
  background: rgba(0, 0, 0, 0.05);
  height: 84vh;
  // height: 80vh;
  overflow: scroll;
}

.btn {
  width: 60rpx;
  height: 60rpx;
  font-size: 26rpx;
  text-align: center;
}

.tabber-inputs-box {
  background: #ffffff;
  position: relative;
  padding: 0 20rpx;
}
.tabber-inputs-box .iconfont {
  font-size: 28px;
  color: #999999;
}

.lv_tabber {
  z-index: 999;
  height: 10vh;
  background: #fff;
  bottom: 0;
  width: 750rpx;
}

.lv_tabber-inputs {
  display: -webkit-flex;
  padding: 20rpx 0 0 0;
}

.lv_textareas {
  position: relative;
  top: 0rpx;
  padding-bottom: 10rpx;
  margin: 10rpx 0 24rpx 0;
  margin-left: 10rpx;
  width: 440rpx;
}

image.wgql_img-mag {
  margin-left: 0;
}

.lv_tabber-img {
  height: 60rpx;
  width: 60rpx;
  margin: 0 20rpx;
}

/* 添加界面 */

.hide {
  display: none;
}

.show {
  display: block;
}

.wgql-flex-img-mag {
  margin-top: 40rpx;
}

.wgql-flex-img {
  width: 750rpx;
  display: -webkit-flex;
  justify-content: center;
}

.wgql-img-box {
  height: 170rpx;
  margin: 20rpx 20rpx;
  text-align: center;
}

.wgql-img {
  width: 100rpx;
  text-align: center;
}

.wgql-navigator {
  width: 126rpx;
  border-radius: 8rpx;
}

.wgql-img-mag {
  height: 120rpx;
  width: 120rpx;
  border: 2rpx solid #ccc;
  border-radius: 12rpx;
  margin-bottom: 10rpx;
  display: -webkit-flex;
  justify-content: center;
  align-items: center;
}
.wgql-img-mag .iconfont {
  font-size: 28px;
  color: #999999;
}

.wgql-image {
  height: 80rpx;
  width: 80rpx;
}

.wgql-flex-img-b {
  padding: 0 20rpx 0 40rpx;
  display: -webkit-flex;
}

text {
  font-size: 26rpx;
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
}

textarea {
  margin: 0 10px;
  padding: 0 6px;
  border-bottom: 2rpx solid #eee;
}
</style>
